> **[info] 利用`R`编制中国期货市场交易日历表。**

# 中国金融交易日

利用`R`语言对日期的处理功能，我们可以借此来编制中国期货市场的交易日历表，用于策略回测（Backtesting）、自动化执行行情订阅（mdApi）、进行程序化交易（tdAip）等。

## 要点

在处理中国期货市场交易日期时，主要有以下几个要点需要特别注意：

- 在当年年末，期货交易所会（提前）公布来年的所有节假日安排，这个可以通过查询[上期所公告网站](http://www.shfe.com.cn/news/)
- 因为我们的历史数据最早可以追踪到`2010`年，所以这里的第一个起始年度为`2010`。更加具体地，第一个真正开始接收数据的日期是 `2010-04-16`
- 如果未来第二日开始放假，则当天的夜盘不交易。这个通过判断`days`与`nights`日期相差的时间超过**3天**来处理，因为正常的周五至下周一的相差刚好是**3天**，而节假日则破坏了这个规律
- `2015`年的中秋节放假比较特别，只有放假两天，当时交易所规定了`2015-09-25`当天的夜盘不交易，所以这个需要在`nights`里面排除。请注意，这是一个大坑。

## 代码

```r
## 生成中国期货交易日
## 1. days  : 日盘时间
## 2. nights: 夜盘时间
## 
## Authoer  : fl@hicloud-investment.com
## Date     : 2017-11-01
## Revised  : 2018-01-15
## =============================================================================
rm(list = ls())
setwd('/home/fl/myData')

## =============================================================================
## 需要安装的 package: bizdays
pkgs <- c("data.table",'magrittr','readr')

if (length(pkgs[!pkgs %in% installed.packages()]) != 0) {
  sapply(pkgs[!pkgs %in% installed.packages()], install.packages)
}

sapply(pkgs, require, character.only = TRUE)

## -----------------------------------------------------------------------------
## 这里需要做选择
## 对于周末的时间，日盘和夜盘的间隔不应该超过 3 天
## 但是，如果是节假日，有可能超过 3 天，那么夜盘就是 NA 了。
## 这个应该很好理解。
setNights <- function(x) {
    for (i in 1:nrow(x)) {
        if (is.na(x$nights[i])) next

        if( (x$days[i] - x$nights[i]) > 3){
          #-- 如果有休假，则日盘与夜盘差超过 3 天
          x$nights[i] <- NA
        }
    }
    x[, ":="(
        nights = gsub('-','', nights),
        days   = gsub('-','', days))]
    return(x)
}
## =============================================================================

## =============================================================================
## 查询交易所对节假日的安排
## http://www.shfe.com.cn/news/
## =============================================================================


## =============================================================================
## http://www.shfe.com.cn/news/notice/911332336.html
yearID <- 2019
daysInYear <- as.numeric(as.Date(paste0(yearID, '-12-31')) -
                           as.Date(paste0(yearID, '-01-01')))
days <- as.Date(0:daysInYear, origin = paste0(yearID, '-01-01')) %>%
  .[-which(weekdays(.) %in% c("Saturday", "Sunday"))] %>%
  .[-c(which(. >= "2019-01-01" & . <= "2019-01-01"),
       which(. >= "2019-02-04" & . <= "2019-02-10"),
       which(. >= "2019-04-05" & . <= "2019-04-07"),
       which(. >= "2019-05-01" & . <= "2019-05-04"),
       which(. >= "2019-06-07" & . <= "2019-06-09"),
       which(. >= "2019-09-13" & . <= "2019-09-15"),
       which(. >= "2019-10-01" & . <= "2019-10-07")
  )]
nights <- c(NA, days[-length(days)]) %>% as.Date(., origin = "1970-01-01")

calendar2019 <- data.table(nights, days) %>% setNights()
calendar2019[days == '20190502', nights := NA]
## =============================================================================
```
