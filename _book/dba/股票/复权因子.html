
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>股票复权因子 · HiBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="方莲">
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-advanced-emoji/emoji-website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-page-toc-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-prism/prism-dracula.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-alerts/style.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-latex-codecogs/latex-codecogs.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../../trading/期货/ctp.html" />
    
    
    <link rel="prev" href="基本信息.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
        
        <li>
            <a href="https://williamlfang.github.io/" target="_blank" class="custom-link">William's Blog</a>
        </li>
    
    

    
    <li class="divider"></li>
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    关于
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">服务器运维</li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <span>
            
                    
                    CentOS7 操作系统
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="../../os/centos/centos7.html">
            
                <a href="../../os/centos/centos7.html">
            
                    
                    安装与配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="../../os/centos/LLVM 扩展逻辑磁盘.html">
            
                <a href="../../os/centos/LLVM 扩展逻辑磁盘.html">
            
                    
                    LLVM 扩展逻辑磁盘
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="../../os/frp.html">
            
                <a href="../../os/frp.html">
            
                    
                    内网穿透
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4" data-path="../../os/centos/gcc.html">
            
                <a href="../../os/centos/gcc.html">
            
                    
                    升级 gcc
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.5" data-path="../../os/centos/gcc-source.html">
            
                <a href="../../os/centos/gcc-source.html">
            
                    
                    源代码编译升级 gcc
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.6" data-path="../../os/centos/CentOS7命令行设置分辨率.html">
            
                <a href="../../os/centos/CentOS7命令行设置分辨率.html">
            
                    
                    命令行设置分辨率
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.7" data-path="../../os/命令行启动 TeamViewer.html">
            
                <a href="../../os/命令行启动 TeamViewer.html">
            
                    
                    命令行启动 TeamViewer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.8" data-path="../../os/centos/cmake.html">
            
                <a href="../../os/centos/cmake.html">
            
                    
                    源代码安装 cmake
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.9" data-path="../../os/sshfs 挂载远程服务器.html">
            
                <a href="../../os/sshfs 挂载远程服务器.html">
            
                    
                    sshfs 挂载远程服务器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.10" data-path="../../os/hicloud_exmail.html">
            
                <a href="../../os/hicloud_exmail.html">
            
                    
                    邮件系统
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.2" >
            
                <span>
            
                    
                    MySQL 数据库
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.1" data-path="../mysql/datapath.html">
            
                <a href="../mysql/datapath.html">
            
                    
                    修改数据存储目录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.2" data-path="../mysql/database.html">
            
                <a href="../mysql/database.html">
            
                    
                    建立数据库命令
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.3" data-path="../mysql/operation.md">
            
                <span>
            
                    
                    数据库运维操作
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.4" data-path="../数据清理要点.html">
            
                <a href="../数据清理要点.html">
            
                    
                    数据清理要点
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.4.1" data-path="../期货/vnpy_tick.html">
            
                <a href="../期货/vnpy_tick.html">
            
                    
                    期货Tick数据处理
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.2.5" data-path="../calendar.html">
            
                <a href="../calendar.html">
            
                    
                    金融交易日历
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.6" data-path="../期货/数据库.html">
            
                <a href="../期货/数据库.html">
            
                    
                    期货数据库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.7" data-path="数据库.html">
            
                <a href="数据库.html">
            
                    
                    股票数据库
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.7.1" data-path="行情数据.html">
            
                <a href="行情数据.html">
            
                    
                    行情数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.7.2" data-path="基本信息.html">
            
                <a href="基本信息.html">
            
                    
                    基本信息
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.2.7.3" data-path="复权因子.html">
            
                <a href="复权因子.html">
            
                    
                    股票复权因子
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">交易系统开发</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../../trading/期货/ctp.html">
            
                <a href="../../trading/期货/ctp.html">
            
                    
                    期货
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../../trading/期货/ctp_md.html">
            
                <a href="../../trading/期货/ctp_md.html">
            
                    
                    行情类
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../../trading/期货/ctp_td.md">
            
                <span>
            
                    
                    交易类
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../../trading/cmake.html">
            
                <a href="../../trading/cmake.html">
            
                    
                    cmake
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../../trading/股票/程序化之路.html">
            
                <a href="../../trading/股票/程序化之路.html">
            
                    
                    股票
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1" data-path="../../trading/股票/xtp-关于.html">
            
                <a href="../../trading/股票/xtp-关于.html">
            
                    
                    中泰·XTP
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1.1" data-path="../../trading/股票/xtp-申请.html">
            
                <a href="../../trading/股票/xtp-申请.html">
            
                    
                    申请
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.1.2" data-path="../../trading/股票/xtp-服务器配置.html">
            
                <a href="../../trading/股票/xtp-服务器配置.html">
            
                    
                    服务器配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.1.3" data-path="../../trading/股票/xtp-运行流程.html">
            
                <a href="../../trading/股票/xtp-运行流程.html">
            
                    
                    运行流程
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.2.2" data-path="../../trading/股票/tora.html">
            
                <a href="../../trading/股票/tora.html">
            
                    
                    华鑫·Tora
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.3" data-path="../../trading/股票/oes.md">
            
                <span>
            
                    
                    宽睿·Oes
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../../trading/vnpy/about.html">
            
                <a href="../../trading/vnpy/about.html">
            
                    
                    vnpy
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.3.1" data-path="../../trading/vnpy/cpp.html">
            
                <a href="../../trading/vnpy/cpp.html">
            
                    
                    封装C++接口
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.2" data-path="../../trading/vnpy/gateway.html">
            
                <a href="../../trading/vnpy/gateway.html">
            
                    
                    gateway类
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.3" data-path="../../trading/vnpy/engine.html">
            
                <a href="../../trading/vnpy/engine.html">
            
                    
                    engine类
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.4" data-path="../../trading/vnpy/app.html">
            
                <a href="../../trading/vnpy/app.html">
            
                    
                    app类
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.5" data-path="../../trading/vnpy/strategy.html">
            
                <a href="../../trading/vnpy/strategy.html">
            
                    
                    strategy类
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.6" data-path="../../trading/vnpy/cython.html">
            
                <a href="../../trading/vnpy/cython.html">
            
                    
                    使用cython
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.7" data-path="../../trading/vnpy/trading.html">
            
                <a href="../../trading/vnpy/trading.html">
            
                    
                    多账户+多策略交易系统
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >股票复权因子</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="&#x8BA1;&#x7B97;&#x80A1;&#x7968;&#x590D;&#x6743;&#x56E0;&#x5B50;">&#x8BA1;&#x7B97;&#x80A1;&#x7968;&#x590D;&#x6743;&#x56E0;&#x5B50;</h1>
<p>&#x5BF9;&#x4E8E;&#x5904;&#x7406;&#x80A1;&#x7968;&#x7684;&#x590D;&#x6743;&#x56E0;&#x5B50;&#xFF0C;&#x76EE;&#x524D;&#x6BD4;&#x8F83;&#x901A;&#x7528;&#x7684;&#x505A;&#x6CD5;&#x662F;&#x91C7;&#x7528;<strong>&#x540E;&#x590D;&#x6743;&#x56E0;&#x5B50;&#x6CD5;</strong>&#xFF0C;&#x539F;&#x7406;&#x662F;<strong>&#x4FDD;&#x8BC1;&#x6301;&#x6709;&#x4ED3;&#x4F4D;&#x7684;&#x5E02;&#x503C;&#x5728;&#x9694;&#x591C;&#x4E0D;&#x53D8;</strong>&#xFF0C;&#x5982;&#x679C;&#x6709;&#x9664;&#x6743;&#x9664;&#x606F;&#x5BFC;&#x81F4;&#x80A1;&#x7968;&#x4EF7;&#x683C;&#x4E0E;&#x6301;&#x4ED3;&#x6570;&#x91CF;&#x53D1;&#x751F;&#x53D8;&#x5316;&#x65F6;&#xFF0C;&#x5219;&#x5E94;&#x5F53;&#x5BF9;&#x4EF7;&#x683C;&#x8FDB;&#x884C;&#x590D;&#x6743;&#x5904;&#x7406;&#xFF0C;&#x4F7F;&#x4E4B;&#x4E0E;&#x6628;&#x65E5;&#x7684;&#x6301;&#x4ED3;&#x5E02;&#x503C;&#x76F8;&#x7B49;&#x3002;</p>
<h2 id="&#x6DA8;&#x8DCC;&#x5E45;&#x590D;&#x6743;&#x6CD5;">&#x6DA8;&#x8DCC;&#x5E45;&#x590D;&#x6743;&#x6CD5;</h2>
<p>&#x56E0;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x5F53;&#x65E5;&#x7684;<strong>&#x6536;&#x76D8;&#x4EF7;</strong>&#x4E0E;&#x4EA4;&#x6613;&#x6240;&#x8FDB;&#x884C;&#x9664;&#x6743;&#x9664;&#x606F;&#x540E;&#x7684;<strong>&#x524D;&#x6536;&#x76D8;&#x4EF7;</strong>&#x6309;&#x7167;&#x4E00;&#x5B9A;&#x7684;&#x6BD4;&#x7387;&#x8FDB;&#x884C;&#x6362;&#x7B97;&#xFF0C;&#x6EE1;&#x8DB3;&#x4EE5;&#x4E0A;&#x7684;&#x6761;&#x4EF6;&#x3002;&#x8FD9;&#x4E2A;&#x6BD4;&#x7387;&#x5C31;&#x662F;<strong>&#x590D;&#x6743;&#x56E0;&#x5B50;</strong>&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x6709;&#x7BC7;&#x6587;&#x7AE0;&#x53EF;&#x4EE5;<a href="http://baostock.com/baostock/images/2/20/BaoStock&#x590D;&#x6743;&#x56E0;&#x5B50;&#x7B80;&#x4ECB;.pdf" target="_blank">&#x53C2;&#x8003;</a>&#x3002;</p>
<p><div class="pdf">
                                
                <div class="pdf__link"><a target="_blank" href="http://baostock.com/baostock/images/2/20/BaoStock&#x590D;&#x6743;&#x56E0;&#x5B50;&#x7B80;&#x4ECB;.pdf">View PDF</a></div>
                
                                <object data="http://baostock.com/baostock/images/2/20/BaoStock&#x590D;&#x6743;&#x56E0;&#x5B50;&#x7B80;&#x4ECB;.pdf" width="100%" height="850" type="application/pdf">
                                    <embed src="http://baostock.com/baostock/images/2/20/BaoStock&#x590D;&#x6743;&#x56E0;&#x5B50;&#x7B80;&#x4ECB;.pdf">
                                        <p>
                                            This browser does not support PDFs. <br>
                                            Please download the PDF to view it: <a target="_blank" href="http://baostock.com/baostock/images/2/20/BaoStock&#x590D;&#x6743;&#x56E0;&#x5B50;&#x7B80;&#x4ECB;.pdf">Download PDF</a>.
                                        </p>
                                    
                                </object>
                            </div></p>
<blockquote>
<p><strong>[info]&#x6DA8;&#x8DCC;&#x5E45;&#x590D;&#x6743;&#x6CD5;</strong>
&#x6DA8;&#x8DCC;&#x5E45;&#x590D;&#x6743;&#x6CD5;&#x4E0D;&#x662F;&#x4EE5;&#x53C2;&#x52A0;&#x5206;&#x914D;&#x7684;&#x5B9E;&#x9645;&#x6536;&#x76CA;&#x4F5C;&#x4E3A;&#x8BA1;&#x7B97;&#x524D;&#x63D0;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x65E0;&#x6CD5;&#x8BA1;&#x7B97;&#x51FA;&#x6295;&#x8D44;&#x8005;&#x53C2;&#x52A0;&#x5206;&#x914D;&#x7684;&#x6536;&#x76CA;&#x3002;&#x6DA8;&#x8DCC;&#x5E45;&#x590D;&#x6743;&#x6CD5;&#x53EF;&#x4EE5;&#x8BA1;&#x7B97;&#x51FA;&#x539F;&#x59CB;&#x8D44;&#x91D1;&#x7684;&#x6536;&#x76CA;&#x7387;&#xFF0C;&#x5047;&#x8BBE;&#x6295;&#x8D44;&#x8005;&#x5728;&#x9664;&#x6743;&#x65E5;&#x524D;&#x4E00;&#x5929;&#x5356;&#x51FA;&#x5168;&#x90E8;&#x7684;&#x80A1;&#x7968;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x9664;&#x6743;&#x65E5;&#x7528;&#x5168;&#x90E8;&#x8D44;&#x91D1;&#x4EE5;&#x6628;&#x6536;&#x76D8;&#x4EF7;&#x4E70;&#x56DE;&#xFF0C;&#x5373;&#x4E0D;&#x53C2;&#x52A0;&#x5206;&#x914D;&#x3002;&#x8FD9;&#x6837;&#x7684;&#x5047;&#x8BBE;&#x57FA;&#x4E8E;&#x5982;&#x4E0B;&#x76EE;&#x7684;&#xFF0C;&#x786E;&#x4FDD;&#x521D;&#x59CB;&#x6295;&#x5165;&#x7684;&#x8D44;&#x91D1;100%&#x5F97;&#x5230;&#x4F7F;&#x7528;&#xFF0C;&#x65E2;&#x4E0D;&#x4F1A;&#x56E0;&#x4E3A;&#x5206;&#x7EA2;&#x800C;&#x5BFC;&#x81F4;&#x6295;&#x8D44;&#x51CF;&#x5C11;&#xFF0C;&#x4E5F;&#x4E0D;&#x4F1A;&#x56E0;&#x4E3A;&#x914D;&#x80A1;&#x800C;&#x5BFC;&#x81F4;&#x6295;&#x8D44;&#x589E;&#x52A0;&#x3002;</p>
<p>&#x6839;&#x636E;&#x6DA8;&#x8DCC;&#x5E45;&#x590D;&#x6743;&#x6CD5;&#xFF0C;&#x590D;&#x6743;&#x56E0;&#x5B50;&#x8BA1;&#x7B97;&#x65B9;&#x6CD5;&#x5982;&#x4E0B;</p>
<ul>
<li>&#x540E;&#x590D;&#x6743;&#x56E0;&#x5B50;=&#x524D;&#x4E00;&#x5929;&#x7684;&#x6536;&#x76D8;&#x4EF7;/&#x5F53;&#x5929;&#x7684;&#x524D;&#x6536;&#xFF0C;&#x4E0A;&#x5E02;&#x9996;&#x65E5;&#x540E;&#x590D;&#x6743;&#x56E0;&#x5B50;&#x4E3A;1</li>
<li>&#x524D;&#x590D;&#x6743;&#x56E0;&#x5B50;=&#x5F53;&#x5929;&#x7684;&#x524D;&#x6536;/&#x524D;&#x4E00;&#x5929;&#x7684;&#x6536;&#x76D8;&#x4EF7;&#xFF0C;&#x6700;&#x8FD1;&#x4E00;&#x6B21;&#x9664;&#x6743;&#x9664;&#x606F;&#x65E5;&#x540E;&#x7684;&#x4EA4;&#x6613;&#x65E5;&#x524D;&#x590D;&#x6743;&#x56E0;&#x5B50;&#x4E3A;1&#x3002;</li>
</ul>
</blockquote>
<h2 id="&#x6838;&#x5FC3;&#x51FD;&#x6570;">&#x6838;&#x5FC3;&#x51FD;&#x6570;</h2>
<p>&#x4EE5;&#x4E0A;&#x7684;&#x539F;&#x7406;&#x4F3C;&#x4E4E;&#x770B;&#x8D77;&#x6765;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x5904;&#x7406;&#x5386;&#x53F2;&#x7684;&#x80A1;&#x7968;&#x4EF7;&#x683C;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x8003;&#x8651;&#x7684;&#x56E0;&#x7D20;&#x6BD4;&#x8F83;&#x591A;&#xFF0C;&#x6BD4;&#x5982;&#x80A1;&#x6539;&#x9996;&#x65E5;&#x7684;&#x4EF7;&#x683C;&#x3001;&#x8BC6;&#x522B;&#x5F53;&#x65E5;&#x4EA4;&#x6613;&#x6240;&#x63A8;&#x9001;&#x7684;&#x524D;&#x6536;&#x76D8;&#x4EF7;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x5254;&#x9664;&#x5206;&#x7EA2;&#x6D3E;&#x606F;&#x3002;</p>
<p>&#x6211;&#x628A;&#x4EE5;&#x4E0A;&#x51E0;&#x4E2A;&#x56E0;&#x7D20;&#x5199;&#x5165;&#x5230; <code>Rcpp</code> &#x7684;&#x51FD;&#x6570;&#x91CC;&#xFF0C;&#x7531;&#x4E00;&#x4E2A;&#x80A1;&#x7968;&#x7684;&#x5386;&#x53F2;&#x4EF7;&#x683C;&#x6240;&#x7EC4;&#x6210;&#x7684; <code>data.table</code> &#x5F00;&#x59CB;&#xFF0C;&#x9010;&#x6B65;&#x8FDB;&#x884C;&#x8BC6;&#x522B;&#x60C5;&#x51B5;&#x3002;</p>
<pre class="language-"><code class="lang-r"><span class="token comment">## &#x66F4;&#x65B0; BFactor</span>
NumericVector update_factor<span class="token punctuation">(</span>DataFrame df<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    StringVector newName <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">&quot;newName&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    NumericVector volume <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">&quot;Volume&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    NumericVector BFactor <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">&quot;BFactor&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    NumericVector factor <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">&quot;factor&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    NumericVector pre_close <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">&quot;PreClose&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    NumericVector lag_close <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">&quot;LagClose&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    StringVector xd <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">&quot;xd&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    int n <span class="token operator">=</span> newName.size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">/</span><span class="token operator">/</span> &#x8BB0;&#x5F97;&#x662F;&#x4ECE; i <span class="token operator">=</span> <span class="token number">1</span> &#x7B2C;&#x4E8C;&#x5929;&#x5F00;&#x59CB;&#x505A;&#x590D;&#x6743;&#x5904;&#x7406;
    <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">/</span><span class="token operator">/</span> &#x5982;&#x679C;&#x662F;&#x80A1;&#x6539;&#x9996;&#x65E5;&#xFF0C;&#x5219;
        <span class="token operator">/</span><span class="token operator">/</span> a. &#x540D;&#x79F0;&#x53D1;&#x751F;&#x53D8;&#x5316;<span class="token punctuation">,</span>
        <span class="token operator">/</span><span class="token operator">/</span> b. &#x524D;&#x4E00;&#x4E2A;&#x4EA4;&#x6613;&#x65E5;&#x662F;&#x505C;&#x724C;&#xFF0C; volume <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token operator">/</span><span class="token operator">/</span> c. pre_close &#xFF01;<span class="token operator">=</span> lag_close <span class="token operator">||</span> &#x6216;&#x8005; pre_close <span class="token operator">==</span> lag_close &#x4F46;&#x662F; &#x4E0D;&#x662F; XD
        <span class="token operator">/</span><span class="token operator">/</span> &#x53E6;&#x5916;&#xFF0C;&#x8FD8;&#x8981;&#x8003;&#x8651;&#x5F53;&#x5929;&#x4EA4;&#x6613;&#x6240;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x8C03;&#x6574;&#x9664;&#x6743;&#x9664;&#x606F; 
        <span class="token operator">/</span><span class="token operator">/</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> &#x6CA1;&#x6709;&#x9488;&#x5BF9;&#x80A1;&#x6539;&#x8FDB;&#x884C;&#x8C03;&#x6574;
        <span class="token operator">/</span><span class="token operator">/</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">,</span> &#x5DF2;&#x7ECF;&#x9664;&#x6743;&#x9664;&#x606F;&#x4E00;&#x6B21;&#x4E86;
        <span class="token keyword">if</span> <span class="token punctuation">(</span> newName<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> newName<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> 
             <span class="token punctuation">(</span>volume<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> volume<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
             <span class="token punctuation">(</span> pre_close<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> lag_close<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>pre_close<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> lag_close<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> factor<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> xd<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">&quot;yes&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> 
           <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>BFactor<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                BFactor<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> max<span class="token punctuation">(</span>NumericVector<span class="token operator">::</span>create<span class="token punctuation">(</span>BFactor<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> factor<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> factor<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>BFactor<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> factor<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;</span> BFactor<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">/</span><span class="token operator">/</span> &#x9632;&#x6B62;&#x540E;&#x590D;&#x6743;&#x53D8;&#x6210; <span class="token operator">&lt;</span> <span class="token number">1</span>
                BFactor<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> double<span class="token punctuation">(</span>factor<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> BFactor<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>           
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    return BFactor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="&#x591A;&#x4E2A;&#x6570;&#x636E;&#x6E90;&#x5BF9;&#x6BD4;&#x9A8C;&#x8BC1;">&#x591A;&#x4E2A;&#x6570;&#x636E;&#x6E90;&#x5BF9;&#x6BD4;&#x9A8C;&#x8BC1;</h2>
<blockquote>
<p><strong>[warning] &#x591A;&#x6570;&#x636E;&#x6E90;&#x5BF9;&#x6BD4;</strong></p>
<p>&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x5355;&#x4E00;&#x6570;&#x636E;&#x7684;&#x8C2C;&#x8BEF;(&#x5B9E;&#x9645;&#x4E0A;&#xFF0C;&#x6839;&#x636E;&#x6211;&#x7684;&#x7ECF;&#x9A8C;&#xFF0C;&#x6240;&#x6709;&#x7684;&#x6570;&#x636E;&#x6E90;&#x90FD;&#x5B58;&#x5728;&#x4E00;&#x5B9A;&#x7A0B;&#x5EA6;&#x7684;<strong>&#x4E0D;&#x7CBE;&#x786E;</strong>)&#xFF0C;&#x6211;&#x4F7F;&#x7528;&#x4E86;&#x81F3;&#x5C11;5&#x4E2A;&#x6570;&#x636E;&#x6E90;&#x8FDB;&#x884C;&#x4EA4;&#x53C9;&#x5BF9;&#x6BD4;&#x9A8C;&#x8BC1;&#xFF0C;&#x4ECE;&#x800C;&#x6781;&#x5927;&#x7684;&#x63D0;&#x9AD8;&#x4E86;&#x80A1;&#x7968;&#x590D;&#x6743;&#x56E0;&#x5B50;&#x7684;&#x8D28;&#x91CF;&#x3002;</p>
</blockquote>
<ul>
<li>DATA_PATH_jq</li>
<li>DATA_PATH_net163</li>
<li>DATA_PATH_jrj</li>
<li>DATA_PATH_guosen</li>
<li>DATA_PATH_exchange</li>
</ul>
<h2 id="&#x5904;&#x7406;&#x6D41;&#x7A0B;">&#x5904;&#x7406;&#x6D41;&#x7A0B;</h2>
<h3 id="&#x8BFB;&#x53D6;&#x6570;&#x636E;">&#x8BFB;&#x53D6;&#x6570;&#x636E;</h3>
<p>&#x7531;&#x4E8E;&#x51E0;&#x4E2A;&#x6570;&#x636E;&#x6E90;&#x7684;&#x683C;&#x5F0F;&#x90FD;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x9700;&#x8981;&#x5355;&#x72EC;&#x9488;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x8BFB;&#x53D6;&#x3002;&#x4EE5;&#x4E0B;&#x662F;&#x76F8;&#x5E94;&#x7684;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x7684;&#x51FD;&#x6570;</p>
<h4 id="&#x8BFB;&#x53D6;&#x805A;&#x5BBD;&#x6570;&#x636E;">&#x8BFB;&#x53D6;&#x805A;&#x5BBD;&#x6570;&#x636E;</h4>
<pre class="language-"><code class="lang-r"><span class="token comment">## &#x8BFB;&#x53D6; jq &#x7684;&#x6570;&#x636E;</span>
read_bar_jq <span class="token operator">&lt;-</span> <span class="token keyword">function</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> start_date <span class="token operator">=</span> FACTORING_START_DATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    datafile <span class="token operator">&lt;-</span> data_files_jq<span class="token punctuation">[</span>symbol <span class="token operator">==</span> code<span class="token punctuation">]</span>

    dt <span class="token operator">&lt;-</span> lapply<span class="token punctuation">(</span>datafile<span class="token operator">$</span>file<span class="token punctuation">,</span> fread<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
        rbindlist<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span>
        .<span class="token punctuation">[</span>time <span class="token operator">&gt;=</span> start_date<span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span>
        .<span class="token punctuation">[</span>order<span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
        .<span class="token punctuation">[</span><span class="token punctuation">,</span> time <span class="token operator">:</span><span class="token operator">=</span> ymd<span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
        .<span class="token punctuation">[</span><span class="token punctuation">,</span> lag_close <span class="token operator">:</span><span class="token operator">=</span> shift<span class="token punctuation">(</span>close<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
        setnames<span class="token punctuation">(</span>.<span class="token punctuation">,</span> <span class="token string">&apos;time&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;TradingDay&apos;</span><span class="token punctuation">)</span>
    dt<span class="token punctuation">[</span><span class="token punctuation">,</span> lag_close <span class="token operator">:</span><span class="token operator">=</span> update_lag_close<span class="token punctuation">(</span>pre_close<span class="token punctuation">,</span> lag_close<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token comment"># dt[, BFactor := round(lag_close / pre_close, 5)]    </span>
    <span class="token comment"># dt[is.na(BFactor), BFactor := 1]</span>
    <span class="token comment"># ## -----------------------------------------</span>
    <span class="token comment"># ## &#x540E;&#x590D;&#x6743;&#x662F; cumprod</span>
    <span class="token comment"># dt[, BFactor := round(cumprod(BFactor), 5)]</span>
    <span class="token comment"># ## -----------------------------------------</span>
    return<span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="&#x8BFB;&#x53D6;&#x7F51;&#x6613;&#x6570;&#x636E;">&#x8BFB;&#x53D6;&#x7F51;&#x6613;&#x6570;&#x636E;</h4>
<pre class="language-"><code class="lang-r"><span class="token comment">## &#x8BFB;&#x53D6; net163 &#x6570;&#x636E;</span>
read_bar_net163 <span class="token operator">&lt;-</span> <span class="token keyword">function</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> start_date <span class="token operator">=</span> FACTORING_START_DATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tmp.exchange <span class="token operator">&lt;-</span> ifelse <span class="token punctuation">(</span>substr<span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&apos;6&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;sh&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;sz&apos;</span><span class="token punctuation">)</span>

    f <span class="token operator">&lt;-</span> data_files_net163<span class="token punctuation">[</span>exchange <span class="token operator">==</span> tmp.exchange <span class="token operator">&amp;</span> symbol <span class="token operator">==</span> code<span class="token punctuation">,</span> file<span class="token punctuation">]</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span>identical<span class="token punctuation">(</span>f<span class="token punctuation">,</span> character<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span>
            print<span class="token punctuation">(</span>sprintf<span class="token punctuation">(</span><span class="token string">&apos;%s:%s &gt;&gt; net163 &gt;&gt; &#x627E;&#x4E0D;&#x5230;&#x6587;&#x4EF6;&apos;</span><span class="token punctuation">,</span> tmp.exchange<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">)</span>
        return<span class="token punctuation">(</span>data.table<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">## LagClose: &#x524D;&#x6536; </span>
    res <span class="token operator">&lt;-</span> lapply<span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file.exists<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
            fread<span class="token punctuation">(</span>x<span class="token punctuation">,</span> integer64 <span class="token operator">=</span> <span class="token string">&apos;numeric&apos;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
        rbindlist<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
        .<span class="token punctuation">[</span><span class="token operator">!</span>duplicated<span class="token punctuation">(</span>&#x65E5;&#x671F;<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
        .<span class="token punctuation">[</span><span class="token punctuation">,</span> &#x65E5;&#x671F; <span class="token operator">:</span><span class="token operator">=</span> ymd<span class="token punctuation">(</span>&#x65E5;&#x671F;<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span>
        .<span class="token punctuation">[</span>order<span class="token punctuation">(</span>&#x65E5;&#x671F;<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span>
        .<span class="token punctuation">[</span>&#x65E5;&#x671F; <span class="token operator">&gt;=</span> ymd<span class="token punctuation">(</span>start_date<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span>
        .<span class="token punctuation">[</span><span class="token punctuation">,</span> newName <span class="token operator">:</span><span class="token operator">=</span> gsub<span class="token punctuation">(</span><span class="token string">&apos;XR|XD|DR &apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;&apos;</span><span class="token punctuation">,</span> &#x540D;&#x79F0;<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span>
        .<span class="token punctuation">[</span><span class="token punctuation">,</span> LagClose <span class="token operator">:</span><span class="token operator">=</span> shift<span class="token punctuation">(</span>&#x6536;&#x76D8;&#x4EF7;<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">]</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span>
            print<span class="token punctuation">(</span>sprintf<span class="token punctuation">(</span><span class="token string">&apos;%s:%s &gt;&gt; net163_bar_allfiles163 &gt;&gt; &#x8BFB;&#x53D6;&#x6570;&#x636E;&#x5C11;&#x4E8E;&#x76EE;&#x6807;&#x8303;&#x56F4;&apos;</span><span class="token punctuation">,</span> 
                 tmp.exchange<span class="token punctuation">,</span> code<span class="token punctuation">)</span>
                 <span class="token punctuation">)</span>
        return<span class="token punctuation">(</span>data.table<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># pb &lt;- txtProgressBar(min = 1, max = nrow(res), style = 1)</span>
    <span class="token comment"># for (i in 2:nrow(res)) {</span>
    <span class="token comment">#     setTxtProgressBar(pb, i)</span>
    <span class="token comment">#     ## ---------------------------------------</span>
    <span class="token comment">#     ## &#x5982;&#x679C; LagClose == 0 &#x8BF4;&#x660E;&#x524D;&#x4E00;&#x5929;&#x662F;&#x505C;&#x724C;&#x7684;</span>
    <span class="token comment">#     ## 1. &#x5982;&#x679C;&#x5728;&#x8FD9;&#x671F;&#x95F4;&#x6709;&#x5206;&#x7EA2;&#x6D3E;&#x606F;,</span>
    <span class="token comment">#     ##    &#x9700;&#x8981;&#x8BC6;&#x522B; &#x4E0A;&#x4E00;&#x4E2A;&#x524D;&#x6536; &#x4E0E; &#x5F53;&#x524D;&#x524D;&#x6536; &#x5982;&#x679C;&#x4E0D;&#x4E00;&#x6837;</span>
    <span class="token comment">#     ##    &#x5219;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x590D;&#x6743;</span>
    <span class="token comment">#     ## 2. &#x5426;&#x5219;&#x4E0D;&#x8981;&#x5904;&#x7406;&#x590D;&#x6743;</span>
    <span class="token comment">#     ## ---------------------------------------</span>
    <span class="token comment">#     # if (res[i, LagClose == 0]) {</span>
    <span class="token comment">#     #     if (res[i-1, &#x6700;&#x9AD8;&#x4EF7; == 0] &amp; res[i-1, &#x524D;&#x6536;&#x76D8;] != res[i, &#x524D;&#x6536;&#x76D8;]) {</span>
    <span class="token comment">#     #         ## &#x5982;&#x679C;&#x524D;&#x4E00;&#x65E5;&#x4E5F;&#x662F;&#x505C;&#x724C;</span>
    <span class="token comment">#     #         res[i, LagClose := res[i-1, &#x524D;&#x6536;&#x76D8;]]</span>
    <span class="token comment">#     #     } else {</span>
    <span class="token comment">#     #         ## &#x524D;&#x9762;&#x4E0D;&#x662F;0</span>
    <span class="token comment">#     #         tmp &lt;- res[&#x65E5;&#x671F; &lt; res[i, &#x65E5;&#x671F;]]</span>
    <span class="token comment">#     #         res[i, LagClose := tmp[.N, &#x524D;&#x6536;&#x76D8;]]</span>
    <span class="token comment">#     #     }</span>
    <span class="token comment">#     # }</span>

    <span class="token comment">#     if (res[i, LagClose == 0]) {</span>
    <span class="token comment">#         res[i, LagClose := res[i-1, &#x524D;&#x6536;&#x76D8;]]</span>
    <span class="token comment">#     }</span>

    <span class="token comment"># }</span>
    <span class="token comment"># cat(&apos;\n&apos;)</span>

    res<span class="token punctuation">[</span><span class="token punctuation">,</span> LagClose <span class="token operator">:</span><span class="token operator">=</span> update_lag_close<span class="token punctuation">(</span>&#x524D;&#x6536;&#x76D8;<span class="token punctuation">,</span> LagClose<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token comment">## -----------------------------------------</span>
    <span class="token comment">## &#x8BA1;&#x7B97;&#x540E;&#x590D;&#x6743; </span>
    <span class="token comment">## &#x4EE5;&#x6628;&#x5929;&#x7684;&#x6536;&#x76D8;&#x4EF7;&#x5356;&#x51FA;&#xFF0C;&#x7136;&#x540E;&#x4EE5;&#x524D;&#x6536;&#x4E70;&#x5165;</span>
    <span class="token comment">## s.t.</span>
    <span class="token comment">##           X              X</span>
    <span class="token comment">## b * ------------- = -----------</span>
    <span class="token comment">##      Close_{t-1}     PreClose_t</span>
    <span class="token comment">## ==&gt;</span>
    <span class="token comment">##      Close_{t-1}</span>
    <span class="token comment">## b =  -----------</span>
    <span class="token comment">##      PreClose_t</span>
    <span class="token comment">## -----------------------------------------</span>

    <span class="token comment"># res[, BFactor := round(LagClose / &#x524D;&#x6536;&#x76D8;, 5)]    </span>
    <span class="token comment"># res[is.na(BFactor), BFactor := 1]</span>

    res <span class="token operator">&lt;-</span> res<span class="token punctuation">[</span><span class="token punctuation">,</span> .<span class="token punctuation">(</span>
            TradingDay <span class="token operator">=</span> ymd<span class="token punctuation">(</span>&#x65E5;&#x671F;<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment"># ExchID = gsub(sprintf(&quot;%s/(.*)[0-9]{6}\\.csv&quot;, DATA_PATH_net163), &apos;\\1&apos;, f),</span>
            ExchID <span class="token operator">=</span> tmp.exchange<span class="token punctuation">,</span>
            StockID <span class="token operator">=</span> gsub<span class="token punctuation">(</span><span class="token string">&apos;[^0-9.]&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;&apos;</span><span class="token punctuation">,</span> &#x80A1;&#x7968;&#x4EE3;&#x7801;<span class="token punctuation">)</span><span class="token punctuation">,</span>
            StockName <span class="token operator">=</span> &#x540D;&#x79F0;<span class="token punctuation">,</span>
            Open <span class="token operator">=</span> &#x5F00;&#x76D8;&#x4EF7;<span class="token punctuation">,</span> High <span class="token operator">=</span> &#x6700;&#x9AD8;&#x4EF7;<span class="token punctuation">,</span> Low <span class="token operator">=</span> &#x6700;&#x4F4E;&#x4EF7;<span class="token punctuation">,</span> Close <span class="token operator">=</span> &#x6536;&#x76D8;&#x4EF7;<span class="token punctuation">,</span>
            PreClose <span class="token operator">=</span> &#x524D;&#x6536;&#x76D8;<span class="token punctuation">,</span>
            LagClose<span class="token punctuation">,</span>
            Chg <span class="token operator">=</span> &#x6DA8;&#x8DCC;&#x989D;<span class="token punctuation">,</span> ChgPct <span class="token operator">=</span> &#x6DA8;&#x8DCC;&#x5E45;<span class="token punctuation">,</span>
            Turnover <span class="token operator">=</span> &#x6362;&#x624B;&#x7387;<span class="token punctuation">,</span> 
            Volume <span class="token operator">=</span> as.numeric<span class="token punctuation">(</span>&#x6210;&#x4EA4;&#x91CF;<span class="token punctuation">)</span><span class="token punctuation">,</span>
            Amount <span class="token operator">=</span> as.numeric<span class="token punctuation">(</span>&#x6210;&#x4EA4;&#x91D1;&#x989D;<span class="token punctuation">)</span><span class="token punctuation">,</span>
            TotalCap <span class="token operator">=</span> &#x603B;&#x5E02;&#x503C;<span class="token punctuation">,</span>
            MarketCap  <span class="token operator">=</span> &#x6D41;&#x901A;&#x5E02;&#x503C;
    <span class="token punctuation">)</span><span class="token punctuation">]</span>

    return<span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="&#x8BFB;&#x53D6;&#x91D1;&#x878D;&#x754C;&#x6570;&#x636E;">&#x8BFB;&#x53D6;&#x91D1;&#x878D;&#x754C;&#x6570;&#x636E;</h4>
<pre class="language-"><code class="lang-r"><span class="token comment">## &#x8BFB;&#x53D6; jrj &#x6570;&#x636E;</span>
read_bar_jrj <span class="token operator">&lt;-</span> <span class="token keyword">function</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> start_date <span class="token operator">=</span> FACTORING_START_DATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    f <span class="token operator">&lt;-</span> sprintf<span class="token punctuation">(</span><span class="token string">&quot;%s/%s.csv&quot;</span><span class="token punctuation">,</span> DATA_PATH_jrj<span class="token punctuation">,</span> code<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> file.exists<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        print<span class="token punctuation">(</span>sprintf<span class="token punctuation">(</span><span class="token string">&apos;%s &gt;&gt; jrj &gt;&gt; &#x627E;&#x4E0D;&#x5230;&#x6587;&#x4EF6;&apos;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">)</span>
        return<span class="token punctuation">(</span>data.table<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    jrj <span class="token operator">&lt;-</span> fread<span class="token punctuation">(</span>f<span class="token punctuation">,</span> colClass <span class="token operator">=</span> <span class="token punctuation">(</span>factor <span class="token operator">=</span> <span class="token string">&apos;numeric&apos;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
        .<span class="token punctuation">[</span><span class="token punctuation">,</span> day <span class="token operator">:</span><span class="token operator">=</span> ymd<span class="token punctuation">(</span>day<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
        .<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;:=&quot;</span><span class="token punctuation">(</span>factor <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> bFactor <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    jrj<span class="token punctuation">[</span>is.na<span class="token punctuation">(</span>factor<span class="token punctuation">)</span><span class="token punctuation">,</span> factor <span class="token operator">:</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">]</span>

    jrj<span class="token punctuation">[</span><span class="token punctuation">,</span> cumFactor <span class="token operator">:</span><span class="token operator">=</span> round<span class="token punctuation">(</span>cumprod<span class="token punctuation">(</span>factor<span class="token punctuation">)</span><span class="token punctuation">,</span> ROUND_DIGITS<span class="token punctuation">)</span><span class="token punctuation">]</span>

    jrj <span class="token operator">&lt;-</span> jrj<span class="token punctuation">[</span>day <span class="token operator">&gt;=</span> ymd<span class="token punctuation">(</span>start_date<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>day <span class="token operator">&lt;=</span> Sys.Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    jrj<span class="token punctuation">[</span><span class="token punctuation">,</span> BFactor <span class="token operator">:</span><span class="token operator">=</span> round<span class="token punctuation">(</span>cumFactor <span class="token operator">/</span> jrj<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> cumFactor<span class="token punctuation">]</span><span class="token punctuation">,</span> ROUND_DIGITS<span class="token punctuation">)</span><span class="token punctuation">]</span>
    jrj <span class="token operator">&lt;-</span> jrj<span class="token punctuation">[</span><span class="token punctuation">,</span> .<span class="token punctuation">(</span>
                TradingDay <span class="token operator">=</span> day<span class="token punctuation">,</span>
                StockID <span class="token operator">=</span> code<span class="token punctuation">,</span> 
                Open <span class="token operator">=</span> open<span class="token punctuation">,</span> High <span class="token operator">=</span> high<span class="token punctuation">,</span> Low <span class="token operator">=</span> low<span class="token punctuation">,</span> Close <span class="token operator">=</span> close<span class="token punctuation">,</span>
                PreClose <span class="token operator">=</span> preClose<span class="token punctuation">,</span> 
                Volume <span class="token operator">=</span> as.numeric<span class="token punctuation">(</span>volume<span class="token punctuation">)</span><span class="token punctuation">,</span> Amount <span class="token operator">=</span> as.numeric<span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                factor<span class="token punctuation">,</span> BFactor
            <span class="token punctuation">)</span><span class="token punctuation">]</span>

    return<span class="token punctuation">(</span>jrj<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">##------------------------------------------------------------------------------</span>
</code></pre>
<h4 id="&#x8BFB;&#x53D6;&#x56FD;&#x4FE1;&#x76D8;&#x540E;&#x884C;&#x60C5;&#x6570;&#x636E;">&#x8BFB;&#x53D6;&#x56FD;&#x4FE1;&#x76D8;&#x540E;&#x884C;&#x60C5;&#x6570;&#x636E;</h4>
<pre class="language-"><code class="lang-r"><span class="token comment">## &#x56FD;&#x4FE1;&#x8BC1;&#x5238;&#x7684;&#x80A1;&#x7968;&#x884C;&#x60C5;&#x6570;&#x636E;</span>
data_files_guosen <span class="token operator">&lt;-</span> sprintf<span class="token punctuation">(</span><span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span> DATA_PATH_guosen<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    list.files<span class="token punctuation">(</span>full.names <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span>
bar_from_guosen <span class="token operator">&lt;-</span> lapply<span class="token punctuation">(</span>data_files_guosen<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">{</span>
        res <span class="token operator">&lt;-</span> fread<span class="token punctuation">(</span>f<span class="token punctuation">,</span> colClasses <span class="token operator">=</span> c<span class="token punctuation">(</span>&#x8BC1;&#x5238;&#x4EE3;&#x7801; <span class="token operator">=</span> <span class="token string">&apos;character&apos;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
            .<span class="token punctuation">[</span><span class="token punctuation">,</span> &#x65E5;&#x671F; <span class="token operator">:</span><span class="token operator">=</span> gsub<span class="token punctuation">(</span><span class="token string">&quot;.*([0-9]{4}-[0-9]{2}-[0-9]{2}).*&quot;</span><span class="token punctuation">,</span> <span class="token string">&apos;\\1&apos;</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> rbindlist<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    .<span class="token punctuation">[</span><span class="token operator">!</span> &#x6240;&#x5C5E;&#x677F;&#x5757; <span class="token percent-operator operator">%in%</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
    .<span class="token punctuation">[</span><span class="token punctuation">,</span> &#x65E5;&#x671F; <span class="token operator">:</span><span class="token operator">=</span> ymd<span class="token punctuation">(</span>&#x65E5;&#x671F;<span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre>
<h4 id="&#x8BFB;&#x53D6;-wind-&#x6570;&#x636E;">&#x8BFB;&#x53D6; Wind &#x6570;&#x636E;</h4>
<pre class="language-"><code class="lang-r"><span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bar_from_wind <span class="token operator">&lt;-</span> sprintf<span class="token punctuation">(</span><span class="token string">&apos;%s/R/ChinaStocks/JoinQuant/wind.csv&apos;</span><span class="token punctuation">,</span> setting<span class="token operator">$</span>ROOT_PATH<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
        fread<span class="token punctuation">(</span><span class="token punctuation">)</span>
    setkey<span class="token punctuation">(</span>bar_from_wind<span class="token punctuation">,</span> <span class="token string">&apos;StockID&apos;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="&#x8BFB;&#x53D6;&#x4EA4;&#x6613;&#x6240;&#x76D8;&#x540E;&#x6570;&#x636E;">&#x8BFB;&#x53D6;&#x4EA4;&#x6613;&#x6240;&#x76D8;&#x540E;&#x6570;&#x636E;</h4>
<pre class="language-"><code class="lang-r">data_files_exchange <span class="token operator">&lt;-</span> sprintf<span class="token punctuation">(</span><span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span> DATA_PATH_exchange<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    list.files<span class="token punctuation">(</span>full.names <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span>
bar_from_exchange <span class="token operator">&lt;-</span> list.files<span class="token punctuation">(</span>data_files_exchange<span class="token punctuation">,</span> full.names <span class="token operator">=</span> T<span class="token punctuation">,</span> recursive <span class="token operator">=</span> T<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    grep<span class="token punctuation">(</span><span class="token string">&apos;&#x80A1;&#x7968;&apos;</span><span class="token punctuation">,</span> .<span class="token punctuation">,</span> value <span class="token operator">=</span> T<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    lapply<span class="token punctuation">(</span>.<span class="token punctuation">,</span> funciton<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>grepl<span class="token punctuation">(</span><span class="token string">&apos;\\.csv&apos;</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res <span class="token operator">&lt;-</span> fread<span class="token punctuation">(</span>f<span class="token punctuation">)</span>      
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            res <span class="token operator">&lt;-</span> read_excel<span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
                as.data.table<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="&#x5904;&#x7406;&#x540E;&#x590D;&#x6743;&#x56E0;&#x5B50;">&#x5904;&#x7406;&#x540E;&#x590D;&#x6743;&#x56E0;&#x5B50;</h3>
<ol>
<li>&#x5206;&#x522B;&#x628A;&#x51E0;&#x4E2A;&#x6570;&#x636E;&#x6E90;&#x7684;&#x65E5;&#x884C;&#x60C5;&#x6570;&#x636E;&#x8BFB;&#x5165;&#x5185;&#x5B58;</li>
<li>&#x4EA4;&#x53C9;&#x9A8C;&#x8BC1;&#x4E0D;&#x540C;&#x6570;&#x636E;&#x6E90;&#x7684;&#x5F02;&#x540C;&#xFF0C;&#x5982;&#x679C;&#x53D1;&#x73B0;&#x660E;&#x663E;&#x4E0D;&#x4E00;&#x81F4;&#xFF0C;&#x5219;&#x505C;&#x6B62;&#x5904;&#x7406;&#xFF0C;&#x63D0;&#x793A;&#x51FA;&#x9519;</li>
<li>&#x6839;&#x636E;&#x80A1;&#x7968;&#x540D;&#x79F0;&#x4E2D;&#x4FE1;&#x606F;&#xFF0C;&#x8BC6;&#x522B;&#x5F53;&#x65E5;&#x5DF2;&#x7ECF;&#x8FDB;&#x884C;&#x9664;&#x6743;&#x9664;&#x606F;&#x7684;&#x80A1;&#x7968;&#xFF0C;&#x5E76;&#x8FDB;&#x884C;&#x6807;&#x8BB0;</li>
<li>&#x4F7F;&#x7528; <code>Rcpp</code> &#x7684;&#x51FD;&#x6570; <code>update_factor</code> &#x8BA1;&#x7B97;&#x590D;&#x6743;&#x56E0;&#x5B50;</li>
</ol>
<pre class="language-"><code class="lang-r"><span class="token comment">## &#x751F;&#x6210; &#x540E;&#x590D;&#x6743;&#x56E0;&#x5B50;</span>
gen_bfactor <span class="token operator">&lt;-</span> <span class="token keyword">function</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dt_jq <span class="token operator">&lt;-</span> read_bar_jq<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>dt_jq<span class="token punctuation">[</span>volume <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        print<span class="token punctuation">(</span>sprintf<span class="token punctuation">(</span><span class="token string">&quot;%s :==&gt; &#x9519;&#x8BEF; :==&gt; nrow(dt_jq[volume != 0]) == 0&quot;</span><span class="token punctuation">,</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
        return<span class="token punctuation">(</span>data.table<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    dt_net163 <span class="token operator">&lt;-</span> read_bar_net163<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    dt_jrj <span class="token operator">&lt;-</span> read_bar_jrj<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    dt_guosen <span class="token operator">&lt;-</span> bar_from_guosen<span class="token punctuation">[</span>&#x8BC1;&#x5238;&#x4EE3;&#x7801; <span class="token operator">==</span> code<span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
        .<span class="token punctuation">[</span><span class="token punctuation">,</span> LagClose <span class="token operator">:</span><span class="token operator">=</span> shift<span class="token punctuation">(</span>&#x6536;<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
        .<span class="token punctuation">[</span><span class="token punctuation">,</span> LagClose <span class="token operator">:</span><span class="token operator">=</span> update_lag_close<span class="token punctuation">(</span>&#x524D;&#x6536;<span class="token punctuation">,</span> LagClose<span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token comment">## net163 &#x7F3A;&#x6570;&#x636E;&#xFF0C;&#x4F46;&#x662F; guosen &#x6709;&#x6570;&#x636E;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>dt_net163<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>dt_guosen<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          dt_net163 <span class="token operator">&lt;-</span> dt_guosen<span class="token punctuation">[</span><span class="token punctuation">,</span> .<span class="token punctuation">(</span>
            TradingDay <span class="token operator">=</span> ymd<span class="token punctuation">(</span>&#x65E5;&#x671F;<span class="token punctuation">)</span><span class="token punctuation">,</span>
            ExchID <span class="token operator">=</span> ifelse<span class="token punctuation">(</span>&#x6240;&#x5C5E;&#x4EA4;&#x6613;&#x6240; <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&apos;sh&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;sz&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            StockID <span class="token operator">=</span> &#x8BC1;&#x5238;&#x4EE3;&#x7801;<span class="token punctuation">,</span>
            StockName <span class="token operator">=</span> &#x8BC1;&#x5238;&#x7B80;&#x79F0;<span class="token punctuation">,</span>
            Open <span class="token operator">=</span> &#x5F00;<span class="token punctuation">,</span> High <span class="token operator">=</span> &#x9AD8;<span class="token punctuation">,</span> Low <span class="token operator">=</span> &#x4F4E;<span class="token punctuation">,</span> Close <span class="token operator">=</span> &#x6536;<span class="token punctuation">,</span>
            PreClose <span class="token operator">=</span> &#x524D;&#x6536;<span class="token punctuation">,</span>
            LagClose<span class="token punctuation">,</span>
            Chg <span class="token operator">=</span> &#x6DA8;&#x8DCC;&#x989D;<span class="token punctuation">,</span> ChgPct <span class="token operator">=</span> eval<span class="token punctuation">(</span>as.symbol<span class="token punctuation">(</span><span class="token string">&quot;&#x6DA8;&#x8DCC;&#x5E45;%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            Turnover <span class="token operator">=</span> eval<span class="token punctuation">(</span>as.symbol<span class="token punctuation">(</span><span class="token string">&quot;&#x6362;&#x624B;&#x7387;%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            Volume <span class="token operator">=</span> as.numeric<span class="token punctuation">(</span>&#x603B;&#x6210;&#x4EA4;&#x91CF;<span class="token punctuation">)</span><span class="token punctuation">,</span>
            Amount <span class="token operator">=</span> as.numeric<span class="token punctuation">(</span>eval<span class="token punctuation">(</span>as.symbol<span class="token punctuation">(</span><span class="token string">&quot;&#x603B;&#x6210;&#x4EA4;&#x989D;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            TotalCap <span class="token operator">=</span> &#x603B;&#x5E02;&#x503C;<span class="token punctuation">,</span>
            MarketCap  <span class="token operator">=</span> &#x6D41;&#x901A;&#x5E02;&#x503C;
          <span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          return<span class="token punctuation">(</span>data.table<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>dt_jq<span class="token punctuation">[</span>volume <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> nrow<span class="token punctuation">(</span>dt_net163<span class="token punctuation">[</span>Volume <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        missing_tradingday <span class="token operator">&lt;-</span> dt_jq<span class="token punctuation">[</span><span class="token operator">!</span> TradingDay <span class="token percent-operator operator">%in%</span> dt_net163<span class="token operator">$</span>TradingDay<span class="token punctuation">,</span> TradingDay<span class="token punctuation">]</span>
        tmp_guosen <span class="token operator">&lt;-</span> dt_guosen<span class="token punctuation">[</span>&#x65E5;&#x671F; <span class="token percent-operator operator">%in%</span> missing_tradingday<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>tmp_guosen<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            missing_bar <span class="token operator">&lt;-</span> dt_guosen<span class="token punctuation">[</span>&#x65E5;&#x671F; <span class="token percent-operator operator">%in%</span> missing_tradingday<span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
                .<span class="token punctuation">[</span><span class="token punctuation">,</span> .<span class="token punctuation">(</span>
                    TradingDay <span class="token operator">=</span> ymd<span class="token punctuation">(</span>&#x65E5;&#x671F;<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    ExchID <span class="token operator">=</span> ifelse<span class="token punctuation">(</span>&#x6240;&#x5C5E;&#x4EA4;&#x6613;&#x6240; <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&apos;sh&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;sz&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    StockID <span class="token operator">=</span> &#x8BC1;&#x5238;&#x4EE3;&#x7801;<span class="token punctuation">,</span>
                    StockName <span class="token operator">=</span> &#x8BC1;&#x5238;&#x7B80;&#x79F0;<span class="token punctuation">,</span>
                    Open <span class="token operator">=</span> &#x5F00;<span class="token punctuation">,</span> High <span class="token operator">=</span> &#x9AD8;<span class="token punctuation">,</span> Low <span class="token operator">=</span> &#x4F4E;<span class="token punctuation">,</span> Close <span class="token operator">=</span> &#x6536;<span class="token punctuation">,</span>
                    PreClose <span class="token operator">=</span> &#x524D;&#x6536;<span class="token punctuation">,</span>
                    LagClose<span class="token punctuation">,</span>
                    Chg <span class="token operator">=</span> &#x6DA8;&#x8DCC;&#x989D;<span class="token punctuation">,</span> ChgPct <span class="token operator">=</span> eval<span class="token punctuation">(</span>as.symbol<span class="token punctuation">(</span><span class="token string">&quot;&#x6DA8;&#x8DCC;&#x5E45;%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Turnover <span class="token operator">=</span> eval<span class="token punctuation">(</span>as.symbol<span class="token punctuation">(</span><span class="token string">&quot;&#x6362;&#x624B;&#x7387;%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                    Volume <span class="token operator">=</span> as.numeric<span class="token punctuation">(</span>&#x603B;&#x6210;&#x4EA4;&#x91CF;<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    Amount <span class="token operator">=</span> as.numeric<span class="token punctuation">(</span>eval<span class="token punctuation">(</span>as.symbol<span class="token punctuation">(</span><span class="token string">&quot;&#x603B;&#x6210;&#x4EA4;&#x989D;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    TotalCap <span class="token operator">=</span> &#x603B;&#x5E02;&#x503C;<span class="token punctuation">,</span>
                    MarketCap  <span class="token operator">=</span> &#x6D41;&#x901A;&#x5E02;&#x503C;
                <span class="token punctuation">)</span><span class="token punctuation">]</span>
            dt_net163 <span class="token operator">&lt;-</span> list<span class="token punctuation">(</span>dt_net163<span class="token punctuation">,</span> missing_bar<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> rbindlist<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG <span class="token operator">&amp;</span> nrow<span class="token punctuation">(</span>dt_jq<span class="token punctuation">[</span>volume <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> nrow<span class="token punctuation">(</span>dt_net163<span class="token punctuation">[</span>Volume <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            print<span class="token punctuation">(</span>sprintf<span class="token punctuation">(</span><span class="token string">&quot;%s :==&gt; &#x9519;&#x8BEF; :==&gt; nrow(dt_jq)[volume != 0]:%s != nrow(dt_net163)[Volume != 0]:%s&quot;</span><span class="token punctuation">,</span>
                          code<span class="token punctuation">,</span> nrow<span class="token punctuation">(</span>dt_jq<span class="token punctuation">)</span><span class="token punctuation">,</span> nrow<span class="token punctuation">(</span>dt_net163<span class="token punctuation">)</span>
                        <span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">## &#x8FD9;&#x4E00;&#x5929; 2016-07-18 &#x805A;&#x5BBD;&#x6570;&#x636E;&#x662F;&#x9519;&#x8BEF;&#x7684;</span>
    dt <span class="token operator">&lt;-</span> merge<span class="token punctuation">(</span>dt_jq<span class="token punctuation">,</span> dt_net163<span class="token punctuation">,</span> by <span class="token operator">=</span> <span class="token string">&apos;TradingDay&apos;</span><span class="token punctuation">,</span> all <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
        .<span class="token punctuation">[</span>TradingDay <span class="token operator">==</span> <span class="token string">&apos;2016-07-18&apos;</span> <span class="token operator">&amp;</span> grep<span class="token punctuation">(</span><span class="token string">&quot;XR|XD|DR&quot;</span><span class="token punctuation">,</span> StockName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;:=&quot;</span><span class="token punctuation">(</span>
            pre_close <span class="token operator">=</span> PreClose<span class="token punctuation">,</span>
            lag_close <span class="token operator">=</span> LagClose
        <span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
        .<span class="token punctuation">[</span><span class="token punctuation">,</span> LagVolume <span class="token operator">:</span><span class="token operator">=</span> shift<span class="token punctuation">(</span>volume<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token comment">## &#x6709;&#x65F6;&#x5019;&#x4F1A;&#x6709;&#x622A;&#x53D6;&#x65E5;&#x671F;&#x7684;&#x9519;&#x8BEF;&#xFF0C;&#x9700;&#x8981;&#x8FC7;&#x6EE4;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG <span class="token operator">&amp;</span> nrow<span class="token punctuation">(</span>dt<span class="token punctuation">[</span>volume <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        print<span class="token punctuation">(</span>sprintf<span class="token punctuation">(</span><span class="token string">&quot;%s :==&gt; &#x9519;&#x8BEF; :==&gt; nrow(dt[volume != 0]) == 0&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">)</span>
        return<span class="token punctuation">(</span>data.table<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG <span class="token operator">&amp;</span> nrow<span class="token punctuation">(</span>dt<span class="token punctuation">[</span>open <span class="token operator">!=</span> Open <span class="token operator">&amp;</span> volume <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       print<span class="token punctuation">(</span>sprintf<span class="token punctuation">(</span><span class="token string">&quot;%s :==&gt; &#x9519;&#x8BEF; :==&gt; nrow(dt[open != Open &amp; volume != 0]) != 0&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">)</span>
       print<span class="token punctuation">(</span>dt<span class="token punctuation">[</span>open <span class="token operator">!=</span> Open <span class="token operator">&amp;</span> volume <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG <span class="token operator">&amp;</span> nrow<span class="token punctuation">(</span>dt<span class="token punctuation">[</span>close <span class="token operator">!=</span> Close <span class="token operator">&amp;</span> volume <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        print<span class="token punctuation">(</span>sprintf<span class="token punctuation">(</span><span class="token string">&quot;%s :==&gt; &#x9519;&#x8BEF; :==&gt; nrow(dt[close != Close &amp; volume != 0]) != 0&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">)</span>
        print<span class="token punctuation">(</span>dt<span class="token punctuation">[</span>pre_close <span class="token operator">!=</span> PreClose <span class="token operator">&amp;</span> volume <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG <span class="token operator">&amp;</span> nrow<span class="token punctuation">(</span>dt<span class="token punctuation">[</span>pre_close <span class="token operator">!=</span> PreClose <span class="token operator">&amp;</span> volume <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        print<span class="token punctuation">(</span>sprintf<span class="token punctuation">(</span><span class="token string">&quot;%s :==&gt; &#x9519;&#x8BEF; :==&gt; nrow(dt[pre_close != PreClose &amp; volume != 0]) != 0&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">)</span>
        print<span class="token punctuation">(</span>dt<span class="token punctuation">[</span>pre_close <span class="token operator">!=</span> PreClose <span class="token operator">&amp;</span> volume <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG <span class="token operator">&amp;</span> nrow<span class="token punctuation">(</span>dt<span class="token punctuation">[</span>lag_close <span class="token operator">!=</span> LagClose <span class="token operator">&amp;</span> volume <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;</span> LagVolume <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        print<span class="token punctuation">(</span>sprintf<span class="token punctuation">(</span><span class="token string">&quot;%s :==&gt; &#x9519;&#x8BEF; :==&gt; nrow(dt[lag_close != LagClose &amp; volume != 0 &amp; LagVolume != 0]) != 0&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">)</span>
        print<span class="token punctuation">(</span>dt<span class="token punctuation">[</span>lag_close <span class="token operator">!=</span> LagClose <span class="token operator">&amp;</span> volume <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;</span> LagVolume <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">## &#x5982;&#x679C;&#x65B0;&#x80A1;&#x7684;&#x6570;&#x636E;&#x6CA1;&#x6709;&#x83B7;&#x53D6;,&#x5219;&#x9700;&#x8981;&#x81EA;&#x52A8;&#x8865;&#x5168;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dt<span class="token punctuation">[</span><span class="token operator">!</span>is.na<span class="token punctuation">(</span>StockName<span class="token punctuation">)</span><span class="token punctuation">,</span> length<span class="token punctuation">(</span>unique<span class="token punctuation">(</span>StockName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dt<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token string">&quot;:=&quot;</span><span class="token punctuation">(</span>
            ExchID <span class="token operator">=</span> dt<span class="token punctuation">[</span><span class="token operator">!</span>is.na<span class="token punctuation">(</span>StockName<span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token punctuation">(</span>ExchID<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            StockName <span class="token operator">=</span> dt<span class="token punctuation">[</span><span class="token operator">!</span>is.na<span class="token punctuation">(</span>StockName<span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token punctuation">(</span>StockName<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            StockID <span class="token operator">=</span> dt<span class="token punctuation">[</span><span class="token operator">!</span>is.na<span class="token punctuation">(</span>StockName<span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token punctuation">(</span>StockID<span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    dt <span class="token operator">&lt;-</span> update_status<span class="token punctuation">(</span>dt<span class="token punctuation">[</span><span class="token operator">!</span> <span class="token punctuation">(</span>volume <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;</span> is.na<span class="token punctuation">(</span>Volume<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> as.data.table<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
        .<span class="token punctuation">[</span><span class="token punctuation">,</span> BFactor <span class="token operator">:</span><span class="token operator">=</span> round<span class="token punctuation">(</span>LagClose <span class="token operator">/</span> PreClose<span class="token punctuation">,</span> ROUND_DIGITS<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
        .<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> BFactor <span class="token operator">:</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span>
        .<span class="token punctuation">[</span>is.na<span class="token punctuation">(</span>BFactor<span class="token punctuation">)</span><span class="token punctuation">,</span> BFactor <span class="token operator">:</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
        .<span class="token punctuation">[</span><span class="token punctuation">,</span> newName <span class="token operator">:</span><span class="token operator">=</span> gsub<span class="token punctuation">(</span><span class="token string">&apos;XR|XD|DR&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;&apos;</span><span class="token punctuation">,</span> StockName<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span>
        .<span class="token punctuation">[</span><span class="token punctuation">,</span> xd <span class="token operator">:</span><span class="token operator">=</span> <span class="token string">&apos;no&apos;</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span>
        .<span class="token punctuation">[</span>grep<span class="token punctuation">(</span><span class="token string">&apos;XR|XD|DR&apos;</span><span class="token punctuation">,</span> StockName<span class="token punctuation">)</span><span class="token punctuation">,</span> xd <span class="token operator">:</span><span class="token operator">=</span> <span class="token string">&apos;yes&apos;</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>dt_jrj<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res <span class="token operator">&lt;-</span> merge<span class="token punctuation">(</span>dt<span class="token punctuation">[</span><span class="token punctuation">,</span> .<span class="token punctuation">(</span>TradingDay<span class="token punctuation">,</span> newName<span class="token punctuation">,</span> xd<span class="token punctuation">,</span> Volume<span class="token punctuation">,</span> BFactor<span class="token punctuation">,</span> PreClose<span class="token punctuation">,</span> LagClose<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     dt_jrj<span class="token punctuation">[</span><span class="token punctuation">,</span> .<span class="token punctuation">(</span>TradingDay<span class="token punctuation">,</span> factor<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     by <span class="token operator">=</span> <span class="token string">&apos;TradingDay&apos;</span><span class="token punctuation">,</span> all.x <span class="token operator">=</span> T<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
            .<span class="token punctuation">[</span>is.na<span class="token punctuation">(</span>factor<span class="token punctuation">)</span><span class="token punctuation">,</span> factor <span class="token operator">:</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span>
            na2zero<span class="token punctuation">(</span>.<span class="token punctuation">,</span> c<span class="token punctuation">(</span><span class="token string">&apos;PreClose&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;LagClose&apos;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            

        dt<span class="token punctuation">[</span><span class="token punctuation">,</span> BFactor <span class="token operator">:</span><span class="token operator">=</span> update_factor<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">]</span>
        dt<span class="token punctuation">[</span>is.na<span class="token punctuation">(</span>BFactor<span class="token punctuation">)</span><span class="token punctuation">,</span> BFactor <span class="token operator">:</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    cols <span class="token operator">&lt;-</span> c<span class="token punctuation">(</span><span class="token string">&apos;PreClose&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;LagClose&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;newName&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;xd&apos;</span><span class="token punctuation">)</span>
    dt<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>cols<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token operator">=</span> <span class="token keyword">NULL</span><span class="token punctuation">]</span>
    <span class="token comment">## -----------------------------------------</span>
    <span class="token comment">## &#x540E;&#x590D;&#x6743;&#x662F; cumprod</span>
    dt<span class="token punctuation">[</span><span class="token punctuation">,</span> BFactor <span class="token operator">:</span><span class="token operator">=</span> round<span class="token punctuation">(</span>cumprod<span class="token punctuation">(</span>BFactor<span class="token punctuation">)</span><span class="token punctuation">,</span> ROUND_DIGITS<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token comment">## -----------------------------------------</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG <span class="token operator">&amp;</span> nrow<span class="token punctuation">(</span>dt_jrj<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cmp.jrj <span class="token operator">&lt;-</span> merge<span class="token punctuation">(</span>dt<span class="token punctuation">,</span> dt_jrj<span class="token punctuation">,</span> by <span class="token operator">=</span> <span class="token string">&apos;TradingDay&apos;</span><span class="token punctuation">,</span> all.x <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
            .<span class="token punctuation">[</span><span class="token operator">!</span>is.na<span class="token punctuation">(</span>factor<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">!</span>is.na<span class="token punctuation">(</span>Volume.y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
            .<span class="token punctuation">[</span><span class="token punctuation">,</span> diff <span class="token operator">:</span><span class="token operator">=</span> BFactor.x <span class="token operator">/</span> BFactor.y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>cmp.jrj<span class="token punctuation">[</span>abs<span class="token punctuation">(</span>diff<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.05</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            print<span class="token punctuation">(</span><span class="token string">&quot;cmp.jrj&quot;</span><span class="token punctuation">)</span>
            print<span class="token punctuation">(</span>cmp.jrj<span class="token punctuation">[</span>abs<span class="token punctuation">(</span>diff<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.05</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            wind_code <span class="token operator">&lt;-</span> ifelse<span class="token punctuation">(</span>substr<span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&apos;6&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;SH&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;SZ&apos;</span><span class="token punctuation">)</span>
            wind <span class="token operator">&lt;-</span> bar_from_wind<span class="token punctuation">[</span>paste0<span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token string">&apos;.&apos;</span><span class="token punctuation">,</span> wind_code<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>TradingDay <span class="token operator">&gt;=</span> <span class="token string">&apos;2010-01-01&apos;</span><span class="token punctuation">]</span>
            wind<span class="token punctuation">[</span><span class="token punctuation">,</span> bfactor <span class="token operator">:</span><span class="token operator">=</span> AdjFactor <span class="token operator">/</span> wind<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> AdjFactor<span class="token punctuation">]</span><span class="token punctuation">]</span>
            wind<span class="token punctuation">[</span><span class="token punctuation">,</span> TradingDay <span class="token operator">:</span><span class="token operator">=</span> ymd<span class="token punctuation">(</span>TradingDay<span class="token punctuation">)</span><span class="token punctuation">]</span>
            cmp.wind <span class="token operator">&lt;-</span> merge<span class="token punctuation">(</span>dt<span class="token punctuation">,</span> wind<span class="token punctuation">,</span> by <span class="token operator">=</span> <span class="token string">&apos;TradingDay&apos;</span><span class="token punctuation">,</span> all <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
                .<span class="token punctuation">[</span><span class="token punctuation">,</span> diff <span class="token operator">:</span><span class="token operator">=</span> <span class="token punctuation">(</span>BFactor <span class="token operator">/</span> bfactor <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
                .<span class="token punctuation">[</span><span class="token operator">!</span>is.na<span class="token punctuation">(</span>bfactor<span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nrow<span class="token punctuation">(</span>cmp.wind<span class="token punctuation">[</span>abs<span class="token punctuation">(</span>diff<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.05</span> <span class="token operator">&amp;</span> Volume.x <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                print<span class="token punctuation">(</span><span class="token string">&quot;cmp.wind&quot;</span><span class="token punctuation">)</span>
                print<span class="token punctuation">(</span>cmp.wind<span class="token punctuation">[</span>abs<span class="token punctuation">(</span>diff<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.05</span> <span class="token operator">&amp;</span> Volume.x <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    return<span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x5F00;&#x542F;&#x5E76;&#x884C;&#x8BA1;&#x7B97;&#x6A21;&#x5F0F;">&#x5F00;&#x542F;&#x5E76;&#x884C;&#x8BA1;&#x7B97;&#x6A21;&#x5F0F;</h3>
<pre class="language-"><code class="lang-r">system.time<span class="token punctuation">(</span><span class="token punctuation">{</span>
  cl <span class="token operator">&lt;-</span> makeCluster<span class="token punctuation">(</span>setting<span class="token punctuation">[</span><span class="token string">&apos;cpu&apos;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">&quot;FORK&quot;</span><span class="token punctuation">,</span> outfile <span class="token operator">=</span> <span class="token string">&apos;~/myLog/log.txt&apos;</span><span class="token punctuation">)</span>
  dt <span class="token operator">&lt;-</span> parLapply<span class="token punctuation">(</span>cl<span class="token punctuation">,</span> all_codes_info<span class="token punctuation">[</span><span class="token punctuation">,</span> symbol<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span><span class="token punctuation">{</span>
    print<span class="token punctuation">(</span>sprintf<span class="token punctuation">(</span><span class="token string">&quot;%s @%s&quot;</span><span class="token punctuation">,</span> symbol<span class="token punctuation">,</span> Sys.time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    gen_bfactor<span class="token punctuation">(</span>symbol<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> rbindlist<span class="token punctuation">(</span><span class="token punctuation">)</span>
  stopCluster<span class="token punctuation">(</span>cl<span class="token punctuation">)</span>
  <span class="token comment"># fst::write_fst(dt,  sprintf(&apos;%s/JoinQuant/Daily/res/daily.fst&apos;, setting$DATA_PATH))</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<footer class="page-footer"><span class="copyright">@william</span><span class="footer-modification">&#x6700;&#x540E;&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;
2019-11-12 20:57:07
</span></footer> <link rel="stylesheet" type="text/css" href="https://storage.googleapis.com/app.klipse.tech/css/codemirror.css"> <script>     window.klipse_settings = {         selector: ".language-klipse, .lang-eval-clojure",         selector_eval_js: ".lang-eval-js",         selector_eval_python_client: ".lang-eval-python",         selector_eval_php: ".lang-eval-php",         selector_eval_scheme: ".lang-eval-scheme",         selector_eval_ruby: ".lang-eval-ruby",         selector_reagent: ".lang-reagent",        selector_google_charts: ".lang-google-chart",        selector_es2017: ".lang-eval-es2017",        selector_jsx: ".lang-eval-jsx",        selector_transpile_jsx: ".lang-transpile-jsx",        selector_render_jsx: ".lang-render-jsx",        selector_react: ".lang-react",        selector_eval_markdown: ".lang-render-markdown",        selector_eval_lambdaway: ".lang-render-lambdaway",        selector_eval_cpp: ".lang-eval-cpp",        selector_eval_html: ".lang-render-html",        selector_sql: ".lang-eval-sql",        selector_brainfuck: "lang-eval-brainfuck",        selector_js: ".lang-transpile-cljs"    }; </script> <script src="https://storage.googleapis.com/app.klipse.tech/plugin/js/klipse_plugin.js"></script>
<script>console.log("plugin-popup....");document.onclick = function(e){ e.target.tagName === "IMG" && window.open(e.target.src,e.target.src)}</script><style>img{cursor:pointer}</style>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="基本信息.html" class="navigation navigation-prev " aria-label="Previous page: 基本信息">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../../trading/期货/ctp.html" class="navigation navigation-next " aria-label="Next page: 期货">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"股票复权因子","level":"2.2.7.3","depth":3,"next":{"title":"期货","level":"3.1","depth":1,"path":"trading/期货/ctp.md","ref":"trading/期货/ctp.md","articles":[{"title":"行情类","level":"3.1.1","depth":2,"path":"trading/期货/ctp_md.md","ref":"trading/期货/ctp_md.md","articles":[]},{"title":"交易类","level":"3.1.2","depth":2,"path":"trading/期货/ctp_td.md","ref":"trading/期货/ctp_td.md","articles":[]},{"title":"cmake","level":"3.1.3","depth":2,"path":"trading/cmake.md","ref":"trading/cmake.md","articles":[]}]},"previous":{"title":"基本信息","level":"2.2.7.2","depth":3,"path":"dba/股票/基本信息.md","ref":"dba/股票/基本信息.md","articles":[]},"dir":"ltr"},"config":{"plugins":["chapter-fold","expandable-chapters-small","expandable-chapters","advanced-emoji","github","splitter","-sharing","sharing-plus","simple-page-toc","page-toc-button","klipse","popup","tbfed-pagefooter","todo","prism","-highlight","advanced-emoji","alerts","url-embed","embed-pdf","copy-code-button","latex-codecogs","include-csv"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"","modify_label":"最后修改时间：","modify_format":"YYYY-MM-DD HH:mm:ss"},"latex-codecogs":{"type":"gif"},"chapter-fold":{},"prism":{"css":["prismjs/themes/prism-dracula.css"]},"include-csv":{},"github":{"url":"https://github.com/williamlfang"},"simple-page-toc":{"maxDepth":3,"skipFirstH1":true},"todo":{},"splitter":{},"search":{},"sharing-plus":{"qq":false,"all":["facebook","google","twitter","instapaper","linkedin","pocket","stumbleupon"],"douban":false,"facebook":true,"weibo":false,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"pocket":true,"google":false,"viber":false,"stumbleupon":false,"qzone":false,"linkedin":false},"popup":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"page-toc-button":{"maxTocDepth":3,"minTocSize":3},"alerts":{},"expandable-chapters-small":{},"copy-code-button":{},"klipse":{"myConfigKey":"it's the default value"},"url-embed":{},"advanced-emoji":{"embedEmojis":false},"sharing":{"douban":true,"google":true,"twitter":true,"weibo":true,"all":["google","twitter","weibo"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"embed-pdf":{},"expandable-chapters":{}},"theme":"default","author":"方莲","pdf":{"pageBreaksBefore":"/","headerTemplate":null,"paperSize":"a4","margin":{"right":62,"left":62,"top":36,"bottom":36},"fontSize":12,"fontFamily":"Arial","footerTemplate":null,"chapterMark":"pagebreak","pageNumbers":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"isbn":"","variables":{},"title":"HiBook","links":{"sharing":{"all":null,"facebook":null,"google":null,"twitter":null,"weibo":null},"sidebar":{"William's Blog":"https://williamlfang.github.io/"}},"gitbook":"*","description":"汉云投资技术手册","extension":null},"file":{"path":"dba/股票/复权因子.md","mtime":"2019-11-12T12:57:07.933Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-11-12T12:59:40.130Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing-plus/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-page-toc-button/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-alerts/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

